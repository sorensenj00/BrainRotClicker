--[[
	ServerMain.server.luau
	
	The central bootstrapper for the server-side architecture.
	Ensures deterministic load order and initializes systems with Dependency Injection.
	
	Load Order:
	1. Core Services (Data, Inventory)
	2. Logic Systems (Brainrot, ItemProduction)
	3. Feature Systems (Shop, etc.)
]]

local ReplicatedStorage = game:GetService("ReplicatedStorage")
local ServerScriptService = game:GetService("ServerScriptService")

-- Ensure Remote Folders Exist
local RemoteEvents = ReplicatedStorage:FindFirstChild("RemoteEvents") or Instance.new("Folder")
RemoteEvents.Name = "RemoteEvents"
RemoteEvents.Parent = ReplicatedStorage

local RemoteFunctions = ReplicatedStorage:FindFirstChild("RemoteFunctions") or Instance.new("Folder")
RemoteFunctions.Name = "RemoteFunctions"
RemoteFunctions.Parent = ReplicatedStorage

local StockMarketFolder = ReplicatedStorage:FindFirstChild("StockMarket") or Instance.new("Folder")
StockMarketFolder.Name = "StockMarket"
StockMarketFolder.Parent = ReplicatedStorage

-- Service Container (Dependency Injection)
local Services = {}

--[[
	Helper to safe require and register a module.
]]
local function registerService(name, path)
	local success, module = pcall(require, path)
	if not success then
		warn(string.format("âŒ Failed to require %s: %s", name, module))
		return nil
	end
	
	print(string.format("ğŸ“¦ Loaded service: %s", name))
	Services[name] = module
	return module
end

--[[
	Helper to initialize a loaded service.
]]
local function initService(name)
	local module = Services[name]
	if module and type(module.Init) == "function" then
		print(string.format("ğŸš€ Initializing %s...", name))
		local success, err = pcall(module.Init, Services)
		if not success then
			warn(string.format("âŒ Error initializing %s: %s", name, err))
		else
			print(string.format("âœ“ %s Initialized", name))
		end
	end
end

--------------------------------------------------------------------------------
-- LOADING SEQUENCE
--------------------------------------------------------------------------------

print("â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—")
print("â•‘           SERVER BOOTSTRAP START          â•‘")
print("â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•")

-- 1. Load All Modules (DataService and PlayerLifecycleManager first to avoid circular deps)
registerService("DataService", script.Parent.DataService)
registerService("PlayerLifecycleManager", script.Parent.PlayerLifecycleManager)
registerService("DataManager", script.Parent.DataManager)
registerService("InventoryManager", script.Parent.InventoryManager)
registerService("MapSystem", script.Parent.MapSystem)
registerService("BrainrotManager", script.Parent.BrainrotManager)
registerService("ItemProductionManager", script.Parent.ItemProductionManager)
registerService("TerrainGenerator", script.Parent.TerrainGenerator)
registerService("PlotManager", script.Parent.PlotManager)
registerService("GridManager", script.Parent.GridManager)
registerService("ItemStorageManager", script.Parent.ItemStorageManager)
registerService("ShopManager", script.Parent.ShopManager)
registerService("TransportManager", script.Parent.TransportManager)
registerService("CartManager", script.Parent.CartManager)
registerService("PrestigeManager", script.Parent.PrestigeManager)
registerService("ArtifactManager", script.Parent.ArtifactManager)
registerService("ArtifactExchangeManager", script.Parent.ArtifactExchangeManager)
registerService("StockMarketManager", script.Parent.StockMarketManager)
registerService("StockMarketBillboards", script.Parent.StockMarketBillboards)
registerService("MarketManager", script.Parent.MarketManager)
registerService("StorageBoxManager", script.Parent.StorageBoxManager)
registerService("StorageUpgradeManager", script.Parent.StorageUpgradeManager)
registerService("ConvenienceUpgradesManager", script.Parent.ConvenienceUpgradesManager)
registerService("BuildModeManager", script.Parent.BuildModeManager)
registerService("IslandShopManager", script.Parent.IslandShopManager)
registerService("MewingManager", script.Parent.MewingManager)
registerService("UnitInteractionManager", script.Parent.UnitInteractionManager)
registerService("AdminService", script.Parent.AdminService)
registerService("CartShopManager", script.Parent.CartShopManager)

-- 2. Initialize All Systems (In Order)

-- Priority 0: Core Infrastructure (must be first)
initService("DataService")
initService("PlayerLifecycleManager")

-- Priority 1: Core Data & Map
initService("DataManager")
initService("TerrainGenerator")
initService("PlotManager")
initService("MapSystem")
initService("InventoryManager")

-- Priority 2: Core Logic
initService("BrainrotManager")
initService("ItemProductionManager")
initService("GridManager")
initService("ItemStorageManager")

-- Priority 3: Features
initService("ShopManager")
initService("TransportManager")
initService("CartManager")
initService("PrestigeManager")
initService("ArtifactManager")
initService("ArtifactExchangeManager")
initService("StockMarketManager")
initService("StockMarketBillboards")
initService("MarketManager")
initService("StorageBoxManager")
initService("StorageUpgradeManager")
initService("ConvenienceUpgradesManager")
initService("BuildModeManager")
initService("IslandShopManager")
initService("MewingManager")
initService("UnitInteractionManager")
initService("AdminService")
initService("CartShopManager")

print("---------------------------------------------")
print("âœ“ Server Bootstrap Complete")
print("---------------------------------------------")
